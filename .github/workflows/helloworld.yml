name: Scheduled deploy # ä»»æ„ã®åå‰

on: #ã„ã¤å®Ÿè¡Œã™ã‚‹ã‹æŒ‡å®š
  schedule:
    - cron: "0 6 * * *" # æ¯æ—¥6æ™‚ã«å®Ÿè¡Œ
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs: #å‡¦ç†å˜ä½ã®æ±ºå®š
  build: #buildã¨ã„ã†ã‚¸ãƒ§ãƒ–ã‚’å®šç¾©
    name: build
    runs-on: ubuntu-latest #ç’°å¢ƒã‚’æŒ‡å®š
    steps: #é †åº
      - name: Checkout code
        uses: actions/checkout@v2 # GitHub ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¦ä½¿ç”¨ã€€å¤–éƒ¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’åˆ©ç”¨ã™ã‚‹æ„å‘³

      - name: Setup Node.js
        uses: actions/setup-node@v2 #@v2ã¯version
        with:
          node-version: "18" # Node.js ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®š

      - name: Install dependencies
        run: npm install # npm ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

      - name: Run build
        run: npm run build # ãƒ“ãƒ«ãƒ‰å‡¦ç†ã‚’å®Ÿè¡Œ

  deploy:
    name: deploy
    runs-on: ubuntu-latest
    needs: build # build ãŒå®Œäº†ã—ã¦ã‹ã‚‰å®Ÿè¡Œ
    steps:
      - name: Checkout code
        uses: actions/checkout@v2 # å†åº¦ãƒªãƒã‚¸ãƒˆãƒªã‚’å–å¾—ï¼ˆdeploy ç”¨ï¼‰

      - name: Setup Node.js and cache
        uses: actions/setup-node@v2
        with:
          node-version: "18"
          cache: "npm" # npm ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦é«˜é€ŸåŒ–

      - name: Install firebase-tools
        run: npm install --save-dev firebase-tools # Firebase CLI ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

      # ğŸ”‘ Base64 åŒ–ã•ã‚ŒãŸ Firebase ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ JSON ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦ç’°å¢ƒå¤‰æ•°ã«è¨­å®š
      - name: Decode Firebase service account key
        run: |
          echo "${{ secrets.FIREBASE_KEY }}" | base64 -d > ./firebase-key.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=${{ github.workspace }}/firebase-key.json" >> $GITHUB_ENV
          # Firebase CLI ãŒèªè¨¼ã«ä½¿ã† JSON ã‚­ãƒ¼ã‚’ä½œæˆã—ã€ç’°å¢ƒå¤‰æ•°ã«è¨­å®š

      # ğŸ”§ Firebase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã‚’æŒ‡å®šï¼ˆæ–‡å­—åˆ—ã§OKã€Base64 ã§ã¯ä¸è¦ï¼‰
      - name: Set Firebase project
        run: ./node_modules/.bin/firebase use ${{ secrets.FIREBASE_PROJECT_ID }}
        # ãƒ‡ãƒ—ãƒ­ã‚¤å¯¾è±¡ã® Firebase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ

      # ğŸš€ Firebase Hosting ã«ãƒ‡ãƒ—ãƒ­ã‚¤
      - name: Deploy to Firebase Hosting
        run: ./node_modules/.bin/firebase deploy
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }} # CLI èªè¨¼ç”¨ãƒˆãƒ¼ã‚¯ãƒ³
          FIREBASE_CLI_EXPERIMENTS: webframeworks # å®Ÿé¨“æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–

      # ğŸ§¹ ä½¿ç”¨å¾Œã«ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¦å®‰å…¨ã«
      - name: Delete GOOGLE_APPLICATION_CREDENTIALS
        run: rm $GOOGLE_APPLICATION_CREDENTIALS
        if: ${{ always() }} # å¸¸ã«å‰Šé™¤ï¼ˆæˆåŠŸãƒ»å¤±æ•—å•ã‚ãšï¼‰
